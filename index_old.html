
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tradutor de Criptografia DEIC-DIG</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: 'Courier New', Courier, monospace;
      background:#0d0d0d; color:#00ff99;
      display:flex; justify-content:center; align-items:center;
      min-height:100vh; padding:20px;
    }
    .frame{
      width:760px; max-width:calc(100% - 40px);
      border-radius:10px; overflow:hidden;
      box-shadow:0 10px 40px rgba(0,255,153,0.08);
      border:1px solid rgba(0,255,153,0.06);
      background:linear-gradient(180deg, rgba(10,10,10,0.98), rgba(15,15,15,0.95));
    }
    .topbar{
      background:linear-gradient(90deg, rgba(0,255,153,0.06), rgba(0,255,153,0.02));
      padding:10px 14px; display:flex; align-items:center; gap:12px;
      border-bottom:1px solid rgba(0,255,153,0.03);
    }
    .dot{ width:12px; height:12px; border-radius:50%;}
    .dot.red{ background:#ff4d4d; box-shadow:0 0 6px rgba(255,77,77,0.2); }
    .dot.yellow{ background:#ffd24d; box-shadow:0 0 6px rgba(255,210,77,0.12); }
    .dot.green{ background:#4dff99; box-shadow:0 0 6px rgba(77,255,153,0.08); }
    h1{ font-size:1.05rem; color:#00ff99; letter-spacing:1px; margin-left:6px; }
    .console-body{ padding:18px; display:grid; grid-template-columns:1fr 360px; gap:18px; }
    label{ color:#bfffdc; font-size:.88rem; display:block; margin-top: 12px; }
    textarea, select, input{
      width:100%; padding:10px 12px; margin-top:8px; border-radius:6px;
      border:1px solid rgba(0,255,153,0.08); background:#0f0f0f; color:#00ff99;
      font-size:14px; transition:all .18s; resize:vertical;
    }
    textarea{ min-height:110px; }
    textarea:focus, input:focus, select:focus{ outline:none; box-shadow:0 0 12px rgba(0,255,153,0.06); border-color:rgba(0,255,153,0.22); }
    .controls{ display:flex; gap:8px; margin-top:10px; align-items: center; }
    .btn{ background:transparent; border:1px solid rgba(0,255,153,0.12); padding:8px 10px; cursor:pointer; color:#00ff99; border-radius:6px; font-family: 'Courier New', Courier, monospace; font-size: 14px;}
    .btn:hover{ background:rgba(0,255,153,0.06); }
    #pasteArea{ border:2px dashed rgba(0,255,153,0.06); padding:12px; text-align:center; color:#8fffd1; cursor:pointer; background:#0f0f0f;}
    #pasteArea:hover{ border-color:rgba(0,255,153,0.14); }
    #preview img{ max-width:100%; max-height:160px; margin-top:10px; border:1px solid rgba(0,255,153,0.04); border-radius:4px; }
    .right-col{ display:flex; flex-direction:column; gap:12px; }
    .output-wrapper{ display:flex; gap:8px; align-items:flex-start; }
    #output{ height:220px; font-family:'Courier New', monospace; }
    .small{ font-size:12px; color:rgba(0,255,153,0.7); }
    .status{ margin-top:6px; font-size:13px; color:#bfffdc; min-height: 1em; }
    @media (max-width:900px){ .console-body{ grid-template-columns:1fr; } #output{ height:140px; } }
  </style>
</head>
<body>
  <div class="frame">
    <div class="topbar">
      <div class="dot red"></div>
      <div class="dot yellow"></div>
      <div class="dot green"></div>
      <h1>DEIC-DIG ‚Äî CRYPTO TERMINAL</h1>
      <div style="flex:1"></div>
      <div class="small">Tema: Terminal / Escuro</div>
    </div>

    <div class="console-body">
      <div>
        <label for="action">O que deseja fazer?</label>
        <select id="action"><option value="encrypt">Criptografar</option><option value="decrypt">Descriptografar</option></select>

        <label for="method">M√©todo:</label>
        <select id="method"><option value="keyword">Cifra de Palavra-Chave (Vigen√®re)</option></select>

        <label for="message">Digite sua mensagem:</label>
        <textarea id="message" placeholder="Sua mensagem secreta aqui..."></textarea>

        <div class="controls">
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
          <button class="btn" onclick="document.getElementById('imageInput').click()">Escolher Arquivo</button>
          <div id="pasteArea" class="btn" tabindex="0">Colar print (CTRL+V)</div>
          <button id="togglePreviewBtn" class="btn">Ocultar Preview</button>
        </div>

        <div id="preview" style="display: none;"></div>

        <label for="keyword">Palavra-Chave:</label>
        <input type="text" id="keyword" placeholder="Ex: DEIC">

        <div class="status" id="ocrStatus"></div>
      </div>

      <div class="right-col">
        <div>
          <label>Resultado:</label>
          <div class="output-wrapper">
            <textarea id="output" readonly></textarea>
            <button id="copyBtn" class="btn">üìã</button>
          </div>
          <div class="small">Use o bot√£o copiar para enviar r√°pido no chat do RP.</div>
        </div>

        <div>
          <label>Op√ß√µes:</label>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="generateQR" class="btn">Gerar QR</button>
            <button id="clearBtn" class="btn">Limpar</button>
          </div>
          <div style="margin-top:8px;color:#9fffd1;font-size:12px">Dica: prints recortados aumentam a acur√°cia do OCR.</div>
        </div>

        <div>
          <label>Confian√ßa OCR:</label>
          <div id="ocrConfidence" class="small">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    const messageInput = document.getElementById('message' );
    const keywordInput = document.getElementById('keyword');
    const output = document.getElementById('output');
    const methodSelect = document.getElementById('method');
    const actionSelect = document.getElementById('action');
    const imageInput = document.getElementById('imageInput');
    const pasteArea = document.getElementById('pasteArea');
    const preview = document.getElementById('preview');
    const ocrStatus = document.getElementById('ocrStatus');
    const ocrConfidence = document.getElementById('ocrConfidence');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');
    const togglePreviewBtn = document.getElementById('togglePreviewBtn');
    const generateQR = document.getElementById('generateQR');

    let worker = null;
    let previewVisible = false;

    // --- L√ìGICA DE CIFRA ORIGINAL RESTAURADA ---
    function encryptKeywordCipher(text, keyword) {
      if (!keyword || keyword.trim() === "") return text;
      const cleanKeyword = keyword.toUpperCase().replace(/[^A-Z]/g, "");
      if (cleanKeyword.length === 0) return text;
      let result = "";
      let keywordIndex = 0;
      const charMap = { '√Å':'A','√Ä':'A','√Ç':'A','√É':'A','√Ñ':'A','√°':'a','√†':'a','√¢':'a','√£':'a','√§':'a','√â':'E','√à':'E','√ä':'E','√ã':'E','√©':'e','√®':'e','√™':'e','√´':'e','√ç':'I','√å':'I','√é':'I','√è':'I','√≠':'i','√¨':'i','√Æ':'i','√Ø':'i','√ì':'O','√í':'O','√î':'O','√ï':'O','√ñ':'O','√≥':'o','√≤':'o','√¥':'o','√µ':'o','√∂':'o','√ö':'U','√ô':'U','√õ':'U','√ú':'U','√∫':'u','√π':'u','√ª':'u','√º':'u','√á':'C','√ß':'c' };
      for (let i = 0; i < text.length; i++) {
        const originalChar = text[i];
        const upperChar = (charMap[originalChar] || originalChar).toUpperCase();
        if (upperChar >= 'A' && upperChar <= 'Z') {
          const tChar = upperChar.charCodeAt(0) - 65;
          const kChar = cleanKeyword.charCodeAt(keywordIndex % cleanKeyword.length) - 65;
          const enc = (tChar + kChar) % 26;
          let newChar = String.fromCharCode(enc + 65);
          if (originalChar === originalChar.toLowerCase()) newChar = newChar.toLowerCase();
          result += newChar;
          keywordIndex++;
        } else {
          result += originalChar;
        }
      }
      return result;
    }

    function decryptKeywordCipher(text, keyword) {
      if (!keyword || keyword.trim() === "") return text;
      const cleanKeyword = keyword.toUpperCase().replace(/[^A-Z]/g, "");
      if (cleanKeyword.length === 0) return text;
      let result = "";
      let keywordIndex = 0;
      for (let i = 0; i < text.length; i++) {
        const originalChar = text[i];
        const upperChar = originalChar.toUpperCase();
        if (upperChar >= 'A' && upperChar <= 'Z') {
          const tChar = upperChar.charCodeAt(0) - 65;
          const kChar = cleanKeyword.charCodeAt(keywordIndex % cleanKeyword.length) - 65;
          const dec = (tChar - kChar + 26) % 26;
          let newChar = String.fromCharCode(dec + 65);
          if (originalChar === originalChar.toLowerCase()) newChar = newChar.toLowerCase();
          result += newChar;
          keywordIndex++;
        } else {
          result += originalChar;
        }
      }
      return result;
    }

    function updateOutput(){
      const method = methodSelect.value;
      const action = actionSelect.value;
      const text = messageInput.value;
      const keyword = keywordInput.value;
      if (!keyword || keyword.trim() === "") {
        output.value = text;
        return;
      }
      if (method === 'keyword') {
        output.value = action === 'encrypt' ? encryptKeywordCipher(text, keyword) : decryptKeywordCipher(text, keyword);
      }
    }

    messageInput.addEventListener('input', updateOutput);
    keywordInput.addEventListener('input', updateOutput);
    methodSelect.addEventListener('change', updateOutput);
    actionSelect.addEventListener('change', updateOutput);

    copyBtn.addEventListener('click', async () => {
      if (output.value.trim() === '') return;
      try {
        await navigator.clipboard.writeText(output.value);
        flashStatus('Copiado!');
      } catch (e) {
        flashStatus('Falha ao copiar');
      }
    });

    clearBtn.addEventListener('click', () => {
      messageInput.value = '';
      keywordInput.value = '';
      output.value = '';
      preview.innerHTML = '';
      preview.style.display = 'none';
      previewVisible = false;
      togglePreviewBtn.textContent = 'Mostrar Preview';
      ocrStatus.textContent = '';
      ocrConfidence.textContent = '‚Äî';
      imageInput.value = '';
      updateOutput();
    });

    togglePreviewBtn.addEventListener('click', () => {
      previewVisible = !previewVisible;
      preview.style.display = previewVisible ? 'block' : 'none';
      togglePreviewBtn.textContent = previewVisible ? 'Ocultar Preview' : 'Mostrar Preview';
    });

    function flashStatus(text) {
      ocrStatus.textContent = text;
      setTimeout(() => { if (ocrStatus.textContent === text) ocrStatus.textContent = ''; }, 2500);
    }

    imageInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (f) processOCR(f);
    });

    // --- L√ìGICA DE COLAR CORRIGIDA ---
    function handlePasteImage(event) {
      const items = (event.clipboardData || window.clipboardData).items;
      for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
          const file = item.getAsFile();
          if(file){
            event.preventDefault();
            processOCR(file);
            return;
          }
        }
      }
    }
    pasteArea.addEventListener('paste', handlePasteImage);
    messageInput.addEventListener('paste', handlePasteImage);

    window.addEventListener('dragover', e => e.preventDefault());
    window.addEventListener('drop', e => {
      e.preventDefault();
      if (e.dataTransfer.files && e.dataTransfer.files.length) {
        processOCR(e.dataTransfer.files[0]);
      }
    });

    async function ensureWorker() {
      if (worker) return worker;
      ocrStatus.textContent = 'Carregando m√≥dulo OCR...';
      try {
        worker = await Tesseract.createWorker({
          logger: m => {
            if (m.status === 'recognizing text') {
              const p = Math.round(m.progress * 100);
              ocrStatus.textContent = `Processando OCR: ${p}%`;
            }
          }
        });
        await worker.loadLanguage('por+eng');
        await worker.initialize('por+eng');
        flashStatus('M√≥dulo OCR pronto.');
        return worker;
      } catch (err) {
        ocrStatus.textContent = 'Falha ao carregar OCR.';
        worker = null;
        throw err;
      }
    }

    async function processOCR(file) {
      if (!file) return;
      preview.innerHTML = '';
      ocrStatus.textContent = 'Preparando imagem...';
      ocrConfidence.textContent = '‚Äî';

      if (!previewVisible) {
        togglePreviewBtn.click();
      }

      try {
        const wk = await ensureWorker();
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = async () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const imgEl = document.createElement('img');
            imgEl.src = canvas.toDataURL('image/png');
            preview.innerHTML = '';
            preview.appendChild(imgEl);

            try {
                const { data: { text, confidence } } = await wk.recognize(canvas);
                const conf = Math.round(confidence);
                
                if (text && text.trim().length > 0 && conf >= 30) {
                    messageInput.value = text.trim();
                    messageInput.focus();
                    flashStatus('Texto extra√≠do com sucesso!');
                    ocrConfidence.textContent = `${conf}%`;
                    updateOutput();
                } else {
                    flashStatus('N√£o foi poss√≠vel extrair texto.');
                    ocrConfidence.textContent = `Baixa confian√ßa (${conf}%)`;
                }
            } catch (recErr) {
                flashStatus('Erro no reconhecimento.');
                console.error('Recognition error:', recErr);
            }
        };
        img.onerror = () => {
            flashStatus('Erro ao carregar imagem.');
        };
        img.src = URL.createObjectURL(file);

      } catch (err) {
        flashStatus('Erro cr√≠tico no OCR.');
        console.error('Error processing OCR:', err);
      }
    }

    generateQR.addEventListener('click', () => {
      const text = output.value.trim();
      if (!text) { flashStatus('Nada para gerar QR'); return; }
      const canvas = document.createElement('canvas');
      QRCode.toCanvas(canvas, text, { margin: 2, scale: 6 }, (error) => {
          if (error) { flashStatus('Erro ao gerar QR'); return; }
          const w = window.open('');
          w.document.write('<html><body style="margin:0; background:#0d0d0d; display:flex; justify-content:center; align-items:center;"></body></html>');
          w.document.body.appendChild(canvas);
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
        updateOutput();
        ensureWorker(); // Pr√©-aquece o worker
    });
  </script>
</body>
</html>
