<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tradutor de Criptografia DEIC-DIG</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: 'Courier New', Courier, monospace;
      background:#0d0d0d; color:#00ff99;
      display:flex; justify-content:center; align-items:center;
      min-height:100vh; padding:20px;
    }
    .frame{
      width:760px; max-width:calc(100% - 40px);
      border-radius:10px; overflow:hidden;
      box-shadow:0 10px 40px rgba(0,255,153,0.08);
      border:1px solid rgba(0,255,153,0.06);
      background:linear-gradient(180deg, rgba(10,10,10,0.98), rgba(15,15,15,0.95));
    }
    .topbar{
      background:linear-gradient(90deg, rgba(0,255,153,0.06), rgba(0,255,153,0.02));
      padding:10px 14px; display:flex; align-items:center; gap:12px;
      border-bottom:1px solid rgba(0,255,153,0.03);
    }
    .dot{ width:12px; height:12px; border-radius:50%;}
    .dot.red{ background:#ff4d4d; box-shadow:0 0 6px rgba(255,77,77,0.2); }
    .dot.yellow{ background:#ffd24d; box-shadow:0 0 6px rgba(255,210,77,0.12); }
    .dot.green{ background:#4dff99; box-shadow:0 0 6px rgba(77,255,153,0.08); }
    h1{ font-size:1.05rem; color:#00ff99; letter-spacing:1px; margin-left:6px; }
    .console-body{ padding:18px; display:grid; grid-template-columns:1fr 360px; gap:18px; }
    label{ color:#bfffdc; font-size:.88rem; }
    textarea, select, input{
      width:100%; padding:10px 12px; margin-top:8px; border-radius:6px;
      border:1px solid rgba(0,255,153,0.08); background:#0f0f0f; color:#00ff99;
      font-size:14px; transition:all .18s; resize:vertical;
    }
    textarea{ min-height:110px; }
    textarea:focus, input:focus, select:focus{ outline:none; box-shadow:0 0 12px rgba(0,255,153,0.06); border-color:rgba(0,255,153,0.22); }
    .controls{ display:flex; gap:8px; margin-top:10px; }
    .btn{ background:transparent; border:1px solid rgba(0,255,153,0.12); padding:8px 10px; cursor:pointer; color:#00ff99; border-radius:6px; }
    .btn:hover{ background:rgba(0,255,153,0.06); }
    #pasteArea{ border:2px dashed rgba(0,255,153,0.06); padding:12px; margin-top:8px; text-align:center; color:#8fffd1; border-radius:6px; cursor:pointer; background:#0f0f0f;}
    #pasteArea:hover{ border-color:rgba(0,255,153,0.14); }
    #preview img{ max-width:100%; max-height:160px; margin-top:10px; border:1px solid rgba(0,255,153,0.04); border-radius:4px; }
    .right-col{ display:flex; flex-direction:column; gap:12px; }
    .output-wrapper{ display:flex; gap:8px; align-items:flex-start; }
    #output{ height:220px; font-family:'Courier New', monospace; }
    .small{ font-size:12px; color:rgba(0,255,153,0.7); }
    .status{ margin-top:6px; font-size:13px; color:#bfffdc; }
    @media (max-width:900px){ .console-body{ grid-template-columns:1fr; } #output{ height:140px; } }
  </style>
</head>
<body>
  <div class="frame">
    <div class="topbar">
      <div class="dot red"></div>
      <div class="dot yellow"></div>
      <div class="dot green"></div>
      <h1>DEIC-DIG ‚Äî CRYPTO TERMINAL</h1>
      <div style="flex:1"></div>
      <div class="small">Tema: Terminal / Escuro</div>
    </div>

    <div class="console-body">
      <div>
        <label for="action">O que deseja fazer?</label>
        <select id="action"><option value="encrypt">Criptografar</option><option value="decrypt">Descriptografar</option></select>

        <label for="method">M√©todo:</label>
        <select id="method"><option value="keyword">Cifra de Palavra-Chave (Vigen√®re)</option></select>

        <label for="message">Digite sua mensagem:</label>
        <textarea id="message" placeholder="Sua mensagem secreta aqui..."></textarea>

        <div class="controls">
          <input type="file" id="imageInput" accept="image/*" class="btn">
          <div id="pasteArea" class="btn" tabindex="0">Colar print (CTRL+V)</div>
          <button id="togglePreviewBtn" class="btn">Mostrar Preview</button>
        </div>

        <div id="preview"></div>

        <label for="keyword">Palavra-Chave:</label>
        <input type="text" id="keyword" placeholder="Ex: DEIC">

        <div class="status" id="ocrStatus"></div>
      </div>

      <div class="right-col">
        <div>
          <label>Resultado:</label>
          <div class="output-wrapper">
            <textarea id="output" readonly></textarea>
            <button id="copyBtn" class="btn">üìã Copiar</button>
          </div>
          <div class="small">Use o bot√£o copiar para enviar r√°pido no chat do RP.</div>
        </div>

        <div>
          <label>Op√ß√µes:</label>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="generateQR" class="btn">Gerar QR (opcional)</button>
            <button id="clearBtn" class="btn">Limpar</button>
          </div>
          <div style="margin-top:8px;color:#9fffd1;font-size:12px">Dica: prints recortados da pr√≥pria mensagem aumentam acur√°cia do OCR.</div>
        </div>

        <div>
          <label>Confian√ßa OCR:</label>
          <div id="ocrConfidence" class="small">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Depend√™ncias -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    // elementos
    const messageInput = document.getElementById('message');
    const keywordInput = document.getElementById('keyword');
    const output = document.getElementById('output');
    const methodSelect = document.getElementById('method');
    const actionSelect = document.getElementById('action');
    const imageInput = document.getElementById('imageInput');
    const pasteArea = document.getElementById('pasteArea');
    const preview = document.getElementById('preview');
    const ocrStatus = document.getElementById('ocrStatus');
    const ocrConfidence = document.getElementById('ocrConfidence');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');
    const togglePreviewBtn = document.getElementById('togglePreviewBtn');
    const generateQR = document.getElementById('generateQR');

    let worker = null;
    let previewVisible = true;

    // ---------------- Cifras (mantive a sua l√≥gica, vers√£o completa) ----------------
    function encryptKeywordCipher(text, keyword) {
      if (!keyword || keyword.trim() === "") return text;
      const cleanKeyword = keyword.toUpperCase().replace(/[^A-Z]/g, "");
      if (cleanKeyword.length === 0) return text;
      let result = "";
      let keywordIndex = 0;
      const charMap = {
        '√Å': 'A', '√Ä': 'A', '√Ç': 'A', '√É': 'A', '√Ñ': 'A',
        '√°': 'a', '√†': 'a', '√¢': 'a', '√£': 'a', '√§': 'a',
        '√â': 'E', '√à': 'E', '√ä': 'E', '√ã': 'E',
        '√©': 'e', '√®': 'e', '√™': 'e', '√´': 'e',
        '√ç': 'I', '√å': 'I', '√é': 'I', '√è': 'I',
        '√≠': 'i', '√¨': 'i', '√Æ': 'i', '√Ø': 'i',
        '√ì': 'O', '√í': 'O', '√î': 'O', '√ï': 'O', '√ñ': 'O',
        '√≥': 'o', '√≤': 'o', '√¥': 'o', '√µ': 'o', '√∂': 'o',
        '√ö': 'U', '√ô': 'U', '√õ': 'U', '√ú': 'U',
        '√∫': 'u', '√π': 'u', '√ª': 'u', '√º': 'u',
        '√á': 'C', '√ß': 'c'
      };
      for (let i = 0; i < text.length; i++) {
        const originalChar = text[i];
        const upperChar = (charMap[originalChar] || originalChar).toUpperCase();
        const charForCipher = upperChar;
        if (charForCipher >= 'A' && charForCipher <= 'Z') {
          const tChar = charForCipher.charCodeAt(0) - 65;
          const kChar = cleanKeyword.charCodeAt(keywordIndex % cleanKeyword.length) - 65;
          const enc = (tChar + kChar) % 26;
          let newChar = String.fromCharCode(enc + 65);
          if (/[√Å√Ä√Ç√É√Ñ√°√†√¢√£√§]/.test(originalChar)) newChar = preserveAccent(newChar, 'A', originalChar);
          else if (/[√â√à√ä√ã√©√®√™√´]/.test(originalChar)) newChar = preserveAccent(newChar, 'E', originalChar);
          else if (/[√ç√å√é√è√≠√¨√Æ√Ø]/.test(originalChar)) newChar = preserveAccent(newChar, 'I', originalChar);
          else if (/[√ì√í√î√ï√ñ√≥√≤√¥√µ√∂]/.test(originalChar)) newChar = preserveAccent(newChar, 'O', originalChar);
          else if (/[√ö√ô√õ√ú√∫√π√ª√º]/.test(originalChar)) newChar = preserveAccent(newChar, 'U', originalChar);
          else if (/[√á√ß]/.test(originalChar)) newChar = preserveAccent(newChar, 'C', originalChar);
          if (originalChar === originalChar.toLowerCase()) newChar = newChar.toLowerCase();
          result += newChar;
          keywordIndex++;
        } else {
          result += originalChar;
        }
      }
      return result;
    }

    function decryptKeywordCipher(text, keyword) {
      if (!keyword || keyword.trim() === "") return text;
      const cleanKeyword = keyword.toUpperCase().replace(/[^A-Z]/g, "");
      if (cleanKeyword.length === 0) return text;
      let result = "";
      let keywordIndex = 0;
      for (let i = 0; i < text.length; i++) {
        const originalChar = text[i];
        const upperChar = (originalChar).toUpperCase();
        const charForCipher = upperChar;
        if (charForCipher >= 'A' && charForCipher <= 'Z') {
          const tChar = charForCipher.charCodeAt(0) - 65;
          const kChar = cleanKeyword.charCodeAt(keywordIndex % cleanKeyword.length) - 65;
          const dec = (tChar - kChar + 26) % 26;
          let newChar = String.fromCharCode(dec + 65);
          if (/[√Å√Ä√Ç√É√Ñ√°√†√¢√£√§]/.test(originalChar)) newChar = preserveAccent(newChar, 'A', originalChar);
          else if (/[√â√à√ä√ã√©√®√™√´]/.test(originalChar)) newChar = preserveAccent(newChar, 'E', originalChar);
          else if (/[√ç√å√é√è√≠√¨√Æ√Ø]/.test(originalChar)) newChar = preserveAccent(newChar, 'I', originalChar);
          else if (/[√ì√í√î√ï√ñ√≥√≤√¥√µ√∂]/.test(originalChar)) newChar = preserveAccent(newChar, 'O', originalChar);
          else if (/[√ö√ô√õ√ú√∫√π√ª√º]/.test(originalChar)) newChar = preserveAccent(newChar, 'U', originalChar);
          else if (/[√á√ß]/.test(originalChar)) newChar = preserveAccent(newChar, 'C', originalChar);
          if (originalChar === originalChar.toLowerCase()) newChar = newChar.toLowerCase();
          result += newChar;
          keywordIndex++;
        } else {
          result += originalChar;
        }
      }
      return result;
    }

    function preserveAccent(newCharBase, baseLetter, originalChar) {
      const mapUpper = {
        'A': { '√Å': '√Å', '√Ä': '√Ä', '√Ç': '√Ç', '√É': '√É', '√Ñ': '√Ñ' },
        'E': { '√â': '√â', '√à': '√à', '√ä': '√ä', '√ã': '√ã' },
        'I': { '√ç': '√ç', '√å': '√å', '√é': '√é', '√è': '√è' },
        'O': { '√ì': '√ì', '√í': '√í', '√î': '√î', '√ï': '√ï', '√ñ': '√ñ' },
        'U': { '√ö': '√ö', '√ô': '√ô', '√õ': '√õ', '√ú': '√ú' },
        'C': { '√á': '√á' }
      };
      const mapLower = {};
      for (const k in mapUpper) {
        mapLower[k.toLowerCase()] = {};
        for (const s in mapUpper[k]) mapLower[k.toLowerCase()][s.toLowerCase()] = mapUpper[k][s].toLowerCase();
      }
      const upperOriginal = originalChar.toUpperCase();
      const candidates = mapUpper[baseLetter] || {};
      for (const k in candidates) {
        if (upperOriginal === (k)) return candidates[k].replace(baseLetter, newCharBase).slice(0,1) || newCharBase;
      }
      return newCharBase;
    }
    // ---------------- fim cifras ----------------

    function updateOutput(){
      const method = methodSelect.value;
      const action = actionSelect.value;
      const text = messageInput.
